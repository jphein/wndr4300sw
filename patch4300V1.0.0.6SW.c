/*
* Convert a binary image that was created for WNDR4300 to use on a WNDR4300sw.
* Usage: ./patch4300V1.0.0.6SW file.img
* Note: file.img is converted in place.
*/

#include <stdio.h>

/*
* 128-byte header for WNDR4300SW.
*/

static char sw[] = {
0x64,0x65,0x76,0x69,0x63,0x65,0x3A,0x57,0x4E,0x44,0x52,0x34,0x33,0x30,0x30,0x53,
0x57,0x0A,0x76,0x65,0x72,0x73,0x69,0x6F,0x6E,0x3A,0x56,0x31,0x2E,0x30,0x2E,0x30,
0x2E,0x36,0x53,0x57,0x0A,0x72,0x65,0x67,0x69,0x6F,0x6E,0x3A,0x0A,0x68,0x64,0x5F,
0x69,0x64,0x3A,0x32,0x39,0x37,0x36,0x33,0x39,0x34,0x38,0x2B,0x30,0x2B,0x31,0x32,
0x38,0x2B,0x31,0x32,0x38,0x2B,0x32,0x78,0x32,0x2B,0x33,0x78,0x33,0x0A,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

main(int argc, char *argv[]) {
    
unsigned int i; long unsigned int j, n; FILE* f;

    /*

     \* Open the file.

     */

    if (argc < 2) return 1;

    if ((f = fopen(argv[1], "r+")) == NULL) return 2;

    /*

     \*  Replace the first 128 bytes with the header for WNDR3800SW.

     */

    for (i=0; i<sizeof(sw); i++) fputc(sw[i], f);

    /*

     \* Get the file size.

     */

    if (fseek(f, 0L, SEEK_END) != 0) return 3; n = ftell(f);

    /*

     \* Replace the last byte with one that results in a CRC of 0xFF.

     */

    if (fseek(f, 0L, SEEK_SET) != 0) return 4;

    for (i=0, j=1; j<n; j++) i = (i + (unsigned int)fgetc(f)) % 0x100;

    fputc((char)(0xFF - i), f);

    /*

     \* Close the file.

     */

    if (fclose(f) != 0) return 5;

    printf("The image file %s was converted successfully\n", argv[1]);

    return 0;

}
